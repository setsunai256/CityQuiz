# game_logic.py
from storage import get_game, set_game, clear_game
from data.cities_list import CITIES  # —Å–ø–∏—Å–æ–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π

# –§–∞–∫—Ç—ã ‚Äî –∫–ª—é—á–∏ –≤ –ù–ò–ñ–ù–ï–ú —Ä–µ–≥–∏—Å—Ç—Ä–µ, –Ω–æ –∏—â–µ–º –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—É —á–µ—Ä–µ–∑ lower()
city_facts = {
    "–º–æ—Å–∫–≤–∞": "–°—Ç–æ–ª–∏—Ü–∞ –†–æ—Å—Å–∏–∏. –û—Å–Ω–æ–≤–∞–Ω–∞ –≤ 1147 –≥–æ–¥—É –Æ—Ä–∏–µ–º –î–æ–ª–≥–æ—Ä—É–∫–∏–º.",
    "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": "–û—Å–Ω–æ–≤–∞–Ω –ü–µ—Ç—Ä–æ–º I –≤ 1703 –≥–æ–¥—É –∫–∞–∫ ¬´–æ–∫–Ω–æ –≤ –ï–≤—Ä–æ–ø—É¬ª.",
    "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥": "–û—Å–Ω–æ–≤–∞–Ω –≤ 1221 –≥–æ–¥—É, –∫—Ä—É–ø–Ω—ã–π —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –Ω–∞ –í–æ–ª–≥–µ.",
    "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É": "¬´–í–æ—Ä–æ—Ç–∞ –ö–∞–≤–∫–∞–∑–∞¬ª, –æ—Å–Ω–æ–≤–∞–Ω –≤ 1749 –≥–æ–¥—É.",
    "–∫–∞–∑–∞–Ω—å": "–°—Ç–æ–ª–∏—Ü–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞. –í –Ω–µ–π ‚Äî –º–µ—á–µ—Ç—å –ö—É–ª-–®–∞—Ä–∏—Ñ.",
    "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫": "–ö—Ä—É–ø–Ω–µ–π—à–∏–π –≥–æ—Ä–æ–¥ –°–∏–±–∏—Ä–∏, –æ—Å–Ω–æ–≤–∞–Ω –≤ 1893 –≥–æ–¥—É –ø—Ä–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ –¢—Ä–∞–Ω—Å—Å–∏–±–∞.",
    "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": "–ß–µ—Ç–≤—ë—Ä—Ç—ã–π –ø–æ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ –≥–æ—Ä–æ–¥ –†–æ—Å—Å–∏–∏, –æ—Å–Ω–æ–≤–∞–Ω –≤ 1723 –≥–æ–¥—É.",
    "—á–µ–ª—è–±–∏–Ω—Å–∫": "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä –Ω–∞ –£—Ä–∞–ª–µ, –æ—Å–Ω–æ–≤–∞–Ω –≤ 1736 –≥–æ–¥—É.",
    "—Å–∞–º–∞—Ä–∞": "–ì–æ—Ä–æ–¥ –Ω–∞ –í–æ–ª–≥–µ, –∫–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–ª–∏—Ü–∞ ‚Äî –∑–¥–µ—Å—å —Å–æ–±–∏—Ä–∞—é—Ç ¬´–°–æ—é–∑—ã¬ª.",
    "–æ–º—Å–∫": "–û–¥–∏–Ω –∏–∑ –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö –≥–æ—Ä–æ–¥–æ–≤ –°–∏–±–∏—Ä–∏, –±—ã–ª –∫—Ä–µ–ø–æ—Å—Ç—å—é —Å 1716 –≥.",
    "—É—Ñ–∞": "–°—Ç–æ–ª–∏—Ü–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω–∞, –æ—Å–Ω–æ–≤–∞–Ω–∞ –≤ 1574 –≥–æ–¥—É.",
    "–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫": "–ì–æ—Ä–æ–¥ –≤ —Ü–µ–Ω—Ç—Ä–µ –°–∏–±–∏—Ä–∏, –æ—Å–Ω–æ–≤–∞–Ω –≤ 1628 –≥–æ–¥—É.",
    "–≤–æ—Ä–æ–Ω–µ–∂": "–†–æ–¥–∏–Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ —Ñ–ª–æ—Ç–∞ ‚Äî –∑–¥–µ—Å—å —Å—Ç—Ä–æ–∏–ª–∏ –ø–µ—Ä–≤—ã–µ –≤–æ–µ–Ω–Ω—ã–µ –∫–æ—Ä–∞–±–ª–∏.",
    "–ø–µ—Ä–º—å": "–ì–æ—Ä–æ–¥ –Ω–∞ –ö–∞–º–µ, –∏–∑–≤–µ—Å—Ç–µ–Ω —Ç–µ–∞—Ç—Ä–æ–º –æ–ø–µ—Ä—ã –∏ –±–∞–ª–µ—Ç–∞.",
    "—Ç–æ–º—Å–∫": "–û—Å–Ω–æ–≤–∞–Ω –≤ 1604 –≥–æ–¥—É. –ú–Ω–æ–≥–æ —Å—Ç–∞—Ä–∏–Ω–Ω—ã—Ö –¥–µ—Ä–µ–≤—è–Ω–Ω—ã—Ö –¥–æ–º–æ–≤ –∏ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤.",
    "–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫": "–ö–æ–Ω–µ—á–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è –¢—Ä–∞–Ω—Å—Å–∏–±–∞, –≥–ª–∞–≤–Ω–∞—è –±–∞–∑–∞ –¢–∏—Ö–æ–æ–∫–µ–∞–Ω—Å–∫–æ–≥–æ —Ñ–ª–æ—Ç–∞.",
    "–∏—Ä–∫—É—Ç—Å–∫": "¬´–ü–∞—Ä–∏–∂ –°–∏–±–∏—Ä–∏¬ª, –≤–æ—Ä–æ—Ç–∞ –≤ –ë–∞–π–∫–∞–ª.",
    "–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥": "–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –≥–æ—Ä–æ–¥, –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–∫—Ä—É–∂—ë–Ω–Ω—ã–π –¥—Ä—É–≥–∏–º–∏ —Å—Ç—Ä–∞–Ω–∞–º–∏.",
    "—Å–æ—á–∏": "–°–∞–º—ã–π –¥–ª–∏–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –†–æ—Å—Å–∏–∏ ‚Äî 145 –∫–º –≤–¥–æ–ª—å –º–æ—Ä—è.",
    "–º—É—Ä–º–∞–Ω—Å–∫": "–ö—Ä—É–ø–Ω–µ–π—à–∏–π –≥–æ—Ä–æ–¥ –∑–∞ –ü–æ–ª—è—Ä–Ω—ã–º –∫—Ä—É–≥–æ–º.",
    "–±–∏–∏—Å–∫": "–û—Å–Ω–æ–≤–∞–Ω –≤ 1709 –≥–æ–¥—É –∫–∞–∫ —Ñ–æ—Ä–ø–æ—Å—Ç –Ω–∞ —é–∂–Ω–æ–π –≥—Ä–∞–Ω–∏—Ü–µ –°–∏–±–∏—Ä–∏.",
    "–≥–∞–π": "–ì–æ—Ä–æ–¥ –≤ –û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏, –Ω–∞–∑–≤–∞–Ω –ø–æ —Ä–µ–∫–µ –ì–∞–π.",
    "—ë–ª–∞–±—É–≥–∞": "–î—Ä–µ–≤–Ω–∏–π –≥–æ—Ä–æ–¥ –Ω–∞ –ö–∞–º–µ, —Ä–æ–¥–∏–Ω–∞ –ø–æ—ç—Ç–µ—Å—Å—ã –ú–∞—Ä–∏–Ω—ã –¶–≤–µ—Ç–∞–µ–≤–æ–π."
}


def get_last_letter(city: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–Ω–∞—á–∞—â—É—é –±—É–∫–≤—É (–±–µ–∑ —å, —ä, –π). city ‚Äî –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ."""
    clean = city.strip().lower()
    for i in range(len(clean) - 1, -1, -1):
        if clean[i] not in '—å—ä–π':
            return clean[i]
    return clean[-1] if clean else ''


def start_game(user_id: int):
    game_state = {"used_cities": [], "last_city": None}
    set_game(user_id, game_state)


def stop_game(user_id: int):
    clear_game(user_id)


def is_valid_city(user_id: int, city_input: str) -> tuple[bool, str, str, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (–≤–∞–ª–∏–¥–µ–Ω, —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ)
    """
    game = get_game(user_id)
    if game is None:
        return False, "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É (/start).", "", ""

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–≤–æ–¥: –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
    city_norm = city_input.strip().lower()

    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ "—Ä–æ—Å—Ç–æ–≤ –Ω–∞ –¥–æ–Ω—É" ‚Üí –∏—â–µ–º –∫–∞–∫ "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É"
    city_norm_for_check = city_norm.replace(" ", "-")

    # –ò—â–µ–º –≤ —Å–ø–∏—Å–∫–µ
    original_city = None
    for c in CITIES:
        if c.lower() == city_norm or c.lower() == city_norm_for_check:
            original_city = c
            city_norm = c.lower()  # —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π lower-–≤–∞—Ä–∏–∞–Ω—Ç
            break

    if not original_city:
        return False, "‚ùå –ù–µ –∑–Ω–∞—é —Ç–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞.", "", ""

    if city_norm in game["used_cities"]:
        return False, "üîÑ –£–∂–µ –±—ã–ª–æ.", "", ""

    last_city = game["last_city"]
    if last_city:
        need_letter = get_last_letter(last_city)
        if city_norm[0] != need_letter:
            return False, f"üî§ –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –Ω–∞ ¬´{need_letter.upper()}¬ª.", "", ""

    return True, "", city_norm, original_city


def make_move(user_id: int, city_input: str) -> str:
    game = get_game(user_id)
    if game is None:
        return "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É (/start)."

    valid, msg, city_norm, city_orig = is_valid_city(user_id, city_input)
    if not valid:
        return msg

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
    game["used_cities"].append(city_norm)
    game["last_city"] = city_norm
    set_game(user_id, game)

    # –û—Ç–≤–µ—Ç –∏–≥—Ä–æ–∫—É ‚Äî —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
    lines = [f"‚úÖ {city_orig} ‚Äî –ø—Ä–∏–Ω—è—Ç–æ!"]

    # –§–∞–∫—Ç ‚Äî –ø–æ –≥–æ—Ä–æ–¥—É –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
    fact = city_facts.get(city_norm, "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç –æ–± —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç üòä")
    lines.append(f"‚ÑπÔ∏è {fact}")
    lines.append("")

    # –•–æ–¥ –±–æ—Ç–∞
    need_letter = get_last_letter(city_norm)
    bot_city_norm = None
    bot_city_orig = None

    for c in CITIES:
        c_norm = c.lower()
        if c_norm not in game["used_cities"] and c_norm[0] == need_letter:
            bot_city_norm = c_norm
            bot_city_orig = c
            break

    if bot_city_orig:
        game["used_cities"].append(bot_city_norm)
        game["last_city"] = bot_city_norm
        set_game(user_id, game)

        lines.append(f"ü§ñ –ë–æ—Ç: {bot_city_orig}")
        bot_fact = city_facts.get(bot_city_norm, "")
        if bot_fact:
            lines.append(f"‚ÑπÔ∏è {bot_fact}")
    else:
        lines.append("üéâ –ë–æ—Ç —Å–¥–∞–ª—Å—è! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!")

    return "\n".join(lines)